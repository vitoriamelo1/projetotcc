# AI coding agent playbook for Esperança Sobre Rodas

This repo is a Django 5.2 app with a custom auth user and two main personas: Paciente and Motorista. The goal is to schedule and fulfill volunteer rides. Use this page to get productive fast.

## Architecture and data flow

- App layout
  - core/: Django project (urls, settings variants in core/settings: base, development, production)
  - rodas/: single Django app with models, views, forms, urls, templates, static
  - static/ -> development assets; staticfiles/ -> collected assets (generated)
- Domain models (see `rodas/models.py`)
  - Usuario (custom auth, AUTH_USER_MODEL), with `tipo_usuario` in TipoUsuario (paciente|motorista|admin)
  - Paciente and Motorista profiles (OneToOne with Usuario). Motorista has approval status and online flag
  - Corrida with status in CorridaStatus: pendente → aceita → em_andamento → motorista_chegou → concluida | cancelada
    - Helper guards: `pode_ser_aceita`, `pode_ser_iniciada`, `pode_marcar_chegada`, `pode_ser_finalizada`
  - Notificacao for user-facing events; Avaliacao for post-ride ratings
- Views and flows (see `rodas/views.py` and `rodas/urls.py`)
  - Authentication: custom email login, logout, register for paciente/motorista
  - Dashboards: per-role dashboards show corridas; motorista sees pending corridas and can accept
  - Ride request: `POST /solicita-corrida/` creates a Corrida. It supports both classic POST/redirect and AJAX JSON
  - API endpoints (JSON): accept corrida, toggle motorista status, update corrida status

## Dev workflows

- Python toolchain managed by uv; Node for TailwindCSS
- Common commands (package.json scripts)
  - Dev server and CSS watch: `npm run dev` (runs `uv run manage.py runserver` + Tailwind watch)
  - Migrations: `npm run makemigrations`, `npm run migrate`
  - Collect static: `npm run static` or `npm run build`
- Docker
  - Dev: `docker compose --profile app up app` (see README; env uses `DJANGO_SETTINGS_MODULE=core.settings.development`)
  - Prod: `docker compose -f docker-compose.prod.yml up` (Gunicorn entrypoint)
- Settings
  - Requires environment variables; `DJANGO_SECRET_KEY` must be set or settings raise
  - Use `core/settings/development.py` for local dev (console email backend)

## Project conventions and patterns

- Templates in `rodas/templates/rodas/**` with Tailwind utility classes; CSS compiled from `static/css/_style.css` → `static/css/style.css`
- Custom user model: always reference `settings.AUTH_USER_MODEL` in new relations
- Roles and permissions checked via `Usuario.tipo_usuario` and related profiles: `perfil_paciente` / `perfil_motorista`
- Corrida lifecycle enforced via model properties; views validate transitions and create `Notificacao` records
- AJAX pattern: endpoints return `{ success, message, ... }` and 400 for validation errors; forms still work without JS
  - Example: `solicitar_corrida_view` detects `X-Requested-With: XMLHttpRequest` and returns JSON with `form.errors.get_json_data()` on 400
- Static files served with WhiteNoise in both dev and prod; use `collectstatic` before deploying

## Where to add things

- New pages: view in `rodas/views.py`, URL in `rodas/urls.py`, template in `rodas/templates/rodas/...`
- New models: `rodas/models.py`; remember migrations and admin as needed
- Form validation: use `forms.py`; surface field-level errors to templates (existing pattern in `SolicitaCorridaform`)
- Notifications or status changes: create `Notificacao` entries and respect `CorridaStatus` guards

## Gotchas

- SECRET_KEY is required; set it in `.env` even in development
- Postgres is the default DB; docker-compose exposes db on port 5439 locally
- Tailwind v4 CLI is used; CSS source is `_style.css`. Run watchers during development or build CSS before running in Docker
- Don’t edit `staticfiles/` manually; it’s generated by collectstatic

## Examples from code

- Accept corrida flow: `aceitar_corrida_view` checks motorista approval/online, asserts `pode_ser_aceita`, updates status to ACEITA, creates Notificacao
- Update status flow: `atualizar_status_corrida_view` enforces valid transitions and writes timestamps
- Ride request form: template `rodas/paciente/_solicita_corrida_form.html` submits via fetch with CSRF and shows inline field errors

If anything here seems off or is missing (e.g., test commands, admin customization, or deployment env details), tell me and I’ll refine this guide.

# AI coding agent instructions

## Git commit

- Before any changes, always commit the current state with a descriptive message.
- Use clear, concise commit messages in the present tense (e.g., "Add user profile model", "Fix ride status transition bug").
- Use conventional commit prefixes when appropriate (e.g., feat:, fix:, docs:, style:, refactor:, test:, chore:).
- The commit message must be in Portuguese from Brazil.
